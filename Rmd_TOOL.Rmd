---
title: ''
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
output: 
  pdf_document:
    fig_caption: false
    latex_engine: xelatex
header-includes:
  - \usepackage{multicol}
  - \usepackage{array}
  - \usepackage{fontspec}
  - \usepackage{longtable}
  - \setlength\LTcapwidth{\textwidth} 
  - \setlength\LTleft{0pt}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
  - \usepackage{caption}
  # - \usepackage{pbox}
  # - \setmainfont{Arial}
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
defaultW <- getOption("warn") 

options(warn = -1) 

library(kableExtra)

if(1){
  D1<-params$DF1
  D2<-params$DF2
  D3<-params$DF3
  Appendix<-params$Appendix
  Title<-params$Title
  if(Title!="")Title<-paste0("**",Title,"**")
  Summary<-c("Medium","No","No","No","Yes","Yes","0.98","102%")
  Settings<-params$Settings
  validation<-params$Validation
  Warnings<-params$Warnings
}else{
  D1<-read.csv("Data_temp.csv",header=TRUE)
  D2<-read.csv("Data_DF2.csv",header=TRUE)
  Appendix<-TRUE
  Title<-"Title"
  if(Title!="")Title<-paste0("**",Title,"**")
  Summary<-c("Medium","No","No","No","Yes","Yes","0.98","102%")
  Settings<-data.frame(
        "shortname"=c(
    "AVL",
    "N_cycles",
    "Pos_minreps",
    "LOD_Cq",
    "IPC_delay",
    "IPC_Cq",
    "IPC_minreps",
    "IPC_Inh_maxreps"
  ),
  "Setting"=c(
    2,
    55,
    1,
    30,
    1,
    37,
    12,
    4
  ),
  "Description"=c("Assay validation level",
                    "Total number of cycles used in qPCR run",
                    "Minimum number of positive qPCR replicates for DNA sample to be considered positive (default: 2)",
                    "Cq value for Limit of Detection (default: determined from standard curve [0])",
                    "Inhibition Threshold, cycle delay relative to pcrncs (default: 1)",
                    "Override Inhibition Threshold, just use minimum cycle number that IPC should have attained (default:0 [OFF])",
                    "IPC threshold: minimum number of replicates that must have been tested for DNA sample to be considered conclusively negative (default:12)",
                    "IPC threshold2: maximum number of replicates that exhibited inhibition for DNA sample to be considered conclusively negative (default:0)"
  ))
  Warnings<-data.frame()
}

if(Appendix==TRUE){
  str_add<-"(see Appendix) "
}else{
  str_add<-""
}

```

\includegraphics[width=.15\textwidth]{NatEng_logo_New-Green-RGB.jpg}
\newline


A report generated by Natural Englandâ€™s eDNA qPCR assay and project validation tool on `r format(Sys.Date(),"%d %B %Y")`. The software has accepted qPCR results and user/defined settings as input and assigned interpretations to the results at three levels: 1) the qPCR replicate level `r str_add` 2) the DNA sample level and 3) the Sampling Point level.  

Project title: `r Title`


```{r, echo=FALSE}
if(dim(Warnings)[1]!=0){
  Str<-"\\vspace{0.5cm}"
}else{
  Str<-""
}
```

\captionsetup[table]{labelformat=empty,justification=justified}

`r Str`

```{r, echo=FALSE}
#Warnings table
Length<-18
Colwidths<-c(0.2,0.1,0.5)
if(dim(Warnings)[1]!=0){
knitr::kable(Warnings,caption="Warnings table. Please note any warnings carefully.") %>%
  kable_styling(latex_options = "hold_position") %>%
  row_spec(0,bold=TRUE) 
}
```
\captionsetup[table]{labelformat=default,justification=justified}
\setcounter{table}{0} 

`r Str`
\underline{Summary of results} **\textcolor{red}{(Still to be calculated)}**

Assay validation level:  `r Summary[1]`\newline
Did any qPCR negative controls (pcrnc) indicate contamination: `r Summary[2]`  \newline 
Did any extraction negative controls (extnc) indicate contamination: `r Summary[3]`  \newline 
Did any field negative controls (fieldnc) indicate contamination: `r Summary[4]` \newline   
Did all positive controls (pc) amplify: `r Summary[5]` \newline
Were standards included on the plate: `r Summary[6]` \newline
R2 = `r sprintf("%s",Summary[7])` \newline
PCR efficiency = `r sprintf("%s",Summary[8])` 



\underline{Settings}\newline


```{r, echo=FALSE,'h'}
Length<-18
Colwidths<-c(0.2,0.1,0.5)
knitr::kable(Settings,caption="Assay settings supplied by user") %>%
  kable_styling(latex_options = "hold_position") %>%
  row_spec(0,bold=TRUE) %>%
column_spec(1,width=sprintf("%4.2fcm",Length*Colwidths[1]),border_left=TRUE)%>%
column_spec(2,width=sprintf("%4.2fcm",Length*Colwidths[2]))%>%
column_spec(3,width=sprintf("%4.2fcm",Length*Colwidths[3]),border_right=TRUE)

Length<-18
validation$user_input[validation$user_input==1]<-"Yes"
validation$user_input[validation$user_input==0]<-"No"
colnames(validation)<-c("Metric","Level of Confidence","Yes/No")
Colwidths<-c(0.5,0.2,0.1)
knitr::kable(validation,caption="Assay validation answers supplied by user") %>%
  kable_styling(latex_options = "hold_position") %>%
  row_spec(0,bold=TRUE) %>%
column_spec(1,width=sprintf("%4.2fcm",Length*Colwidths[1]),border_left=TRUE)%>%
column_spec(2,width=sprintf("%4.2fcm",Length*Colwidths[2]))%>%
column_spec(3,width=sprintf("%4.2fcm",Length*Colwidths[3]),border_right=TRUE)
```

\newpage
\underline{Results and interpretations}\newline

**\textcolor{red}{(Figure 1 still to come)}**

```{r, echo=FALSE}

Length<-19
knitr::kable(D3,caption=" Interpretation of results at Sampling point level",col.names=names(D3)) %>%
  row_spec(0,bold=TRUE,angle=90)%>%
  # kable_styling(latex_options = c("repeat_header"))%>%
column_spec(1,border_left=TRUE)%>%
# column_spec(2,width=sprintf("%4.2fcm",Length*Colwidths2[2]))%>%
# column_spec(3,width=sprintf("%4.2fcm",Length*Colwidths2[3]))%>%
# column_spec(4,width=sprintf("%4.2fcm",Length*Colwidths2[4]))%>%
# column_spec(5,width=sprintf("%4.2fcm",Length*Colwidths2[5]))%>%
column_spec(7,border_right=TRUE)


Names<-colnames(D1)
Nchar_header1<-array(NA,length(Names))
for(k in seq_along(Names)){
  if(grepl("_",Names[k])){
    temp<-strsplit(Names[k],"_")[[1]]
    Nchar_header1[k]<-max(nchar(temp),na.rm=TRUE)
    Names[k]<-paste(temp,collapse=" ")
  }else{
    Nchar_header1[k]<-nchar(Names[k])
  }
}

for(J in 1:2){
  D<-eval(parse(text=paste0("D",J)))
  if(J==2){
  D$DNA_Sample<-as.character(D$DNA_Sample)
  w<-which(grepl("_",D$DNA_Sample))
  if(length(w)>=1){
    for(k in 1:length(w)){
      temp<-D$DNA_Sample[w[k]]
      D$DNA_Sample[w[k]]<-paste(strsplit(as.character(temp),"_")[[1]],collapse=" ")
    }
  }
  }
  NC<-dim(D)[2]
  NR<-dim(D)[1]
  eval(parse(text=paste0("D",J,"<-D")))
  eval(parse(text=paste0("NC",J,"<-NC")))
  eval(parse(text=paste0("NR",J,"<-NR")))
}



#####################
#DF2
row.names(D2)<-1:dim(D2)[1]
D<-D2
NC<-NC2
NR<-NR2
Names2<-names(D2)
Nchar_header2<-array(NA,length(Names))
for(k in seq_along(Names2)){
  if(grepl("_",Names2[k])){
    temp<-strsplit(Names2[k],"_")[[1]]
    Names2[k]<-paste(temp,collapse=" ")
    Nchar_header2[k]<-max(nchar(temp),na.rm=TRUE)
  }else{
    Nchar_header2[k]<-nchar(Names2[k])
  }
}

######################
#Establish column widths
Nchar<-array(NA,dim=NC)
for(k in 1:NC){
  #Longest word in the header
  n<-c(Nchar_header2[k],nchar(as.character(D[,k])))
  n<-c(nchar(as.character(D[,k])))
  Nchar[k]<-max(n,na.rm=TRUE)
  if(length(which(!is.na(n)))==0)Nchar[k]<-3
  if(length(which(is.na(n)))!=0)Nchar[k]<-3
}
Colwidths2<-array(NA,dim=NC)
Colwidths2[length(Colwidths2)]<-0.5
temp<-0.8-Colwidths2[NC]
Colwidths2[1:(NC-1)]<-temp*Nchar[1:(NC-1)]/sum(Nchar[1:(NC-1)])


Length<-19
knitr::kable(D2,caption="Interpretation of results at DNA sample level",col.names=Names2) %>%
  row_spec(0,bold=TRUE,angle=90) %>%
  kable_styling(latex_options = c("repeat_header"))%>%
column_spec(1,width=sprintf("%4.2fcm",Length*Colwidths2[1]),border_left=TRUE)%>%
column_spec(2,width=sprintf("%4.2fcm",Length*Colwidths2[2]))%>%
column_spec(3,width=sprintf("%4.2fcm",Length*Colwidths2[3]))%>%
column_spec(4,width=sprintf("%4.2fcm",Length*Colwidths2[4]))%>%
column_spec(5,width=sprintf("%4.2fcm",Length*Colwidths2[5]))%>%
column_spec(6,width=sprintf("%4.2fcm",Length*Colwidths2[6]))%>%
column_spec(7,width=sprintf("%4.2fcm",Length*Colwidths2[7]))%>%
column_spec(8,width=sprintf("%4.2fcm",Length*Colwidths2[8]),border_right=TRUE)
String<-"\\textbf{Report} \\newline \\newline Table 1: Interpretation of results at DNA sample level"

if(0){
  
  String<-paste(String
                ,"\\begin{longtable}{|p{0.125\\textwidth} |p{0.125\\textwidth}  |p{0.125\\textwidth} |p{0.5\\textwidth} |} \\hline")
  
  
  String<-paste(String,paste(Names2,collapse="&"),"\\\\\\hline \\endhead")
  for(j in 1:NR){
    String<-paste(String,paste(as.matrix(D[j,]),collapse="&"))
    String<-paste(String,"\\\\\\hline")
  }
  
  String<-paste(String,"\\end{longtable}")
}

#####################
#DF1
D<-D1
NC<-NC1
NR<-NR1

######################
#Establish column widths
Nchar<-array(NA,dim=NC)
for(k in 1:NC){
  #Longest word in the header
  n<-c(Nchar_header1[k],nchar(as.character(D[,k])))
  n<-c(nchar(as.character(D[,k])))
  Nchar[k]<-max(n,na.rm=TRUE)
  if(length(which(!is.na(n)))==0)Nchar[k]<-3
  if(length(which(is.na(n)))!=0)Nchar[k]<-3
}
Colwidths<-array(NA,dim=NC)
Colwidths[length(Colwidths)]<-0.3
temp<-0.8-Colwidths[NC]
Colwidths[1:(NC-1)]<-temp*Nchar[1:(NC-1)]/sum(Nchar[1:(NC-1)])

########################

if(0){
String<-paste(String,"\\newpage\\textbf{Appendix} \\newline \\newline Table A1: Description to come (DF1) ")

String<-paste(String
              # ,"\\resizebox{\\textwidth}{!}{\\begin{tabular}{",paste(rep("c",NC),collapse="|"),"}")
              ,"\\begin{longtable}{",paste(sprintf("|p{%5.4f \\textwidth}",Colwidths),collapse=" ")," |} \\hline")

String<-paste(String,paste(Names,collapse="&"),"\\\\\\hline \\endhead \\small")
for(j in 1:NR){
  String<-paste(String,paste(as.matrix(D[j,]),collapse="&"))
  String<-paste(String,"\\\\\\hline")
}

String<-paste(String,"\\end{longtable}")
}
```
<!-- \pagenumbering{gobble} -->


<!-- `r String` -->


```{r, echo=FALSE}
if(Appendix==TRUE){
  Str<-"\\newpage \\blandscape "
  Str2<-"\\captionsetup[table]{labelformat=empty,justification=justified}"
  Str3<-"## Appendix"
}else{
  Str<-""
  Str2<-""
  Str3<-""
}
  
```

`r Str`
`r Str2`
`r Str3`
<!-- \newpage -->
<!-- \blandscape -->

<!-- \captionsetup[table]{labelformat=empty,justification=justified} -->
<!-- ## Appendix -->

```{r, echo=FALSE}
if(Appendix==TRUE){
  Length<-23
  knitr::kable(D1,longtable=TRUE,caption="Table A1. Interpretation of results at qPCR replicate level",col.names=Names) %>%
    row_spec(0,bold=TRUE,angle=90) %>%
    kable_styling(latex_options = c("repeat_header"))%>%
    column_spec(1,width=sprintf("%4.2fcm",Length*Colwidths[1]),border_left=TRUE)%>%
    column_spec(2,width=sprintf("%4.2fcm",Length*Colwidths[2]))%>%
    column_spec(3,width=sprintf("%4.2fcm",Length*Colwidths[3]))%>%
    column_spec(4,width=sprintf("%4.2fcm",Length*Colwidths[4]))%>%
    column_spec(5,width=sprintf("%4.2fcm",Length*Colwidths[5]))%>%
    column_spec(6,width=sprintf("%4.2fcm",Length*Colwidths[6]))%>%
    column_spec(7,width=sprintf("%4.2fcm",Length*Colwidths[7]))%>%
    column_spec(8,width=sprintf("%4.2fcm",Length*Colwidths[8]))%>%
    column_spec(9,width=sprintf("%4.2fcm",Length*Colwidths[9]))%>%
    column_spec(10,width=sprintf("%4.2fcm",Length*Colwidths[10]))%>%
    column_spec(11,width=sprintf("%4.2fcm",Length*Colwidths[11]))%>%
    column_spec(12,width=sprintf("%4.2fcm",Length*Colwidths[12]))%>%
    column_spec(13,width=sprintf("%4.2fcm",Length*Colwidths[13]),border_right=TRUE)
}


options(warn = defaultW)
```

```{r, echo=FALSE}
if(Appendix==TRUE){
  Str<-"\\elandscape"
}else{
  Str<-""
}
  
```

`r Str`



